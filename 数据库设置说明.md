# 用户账户系统设置说明

## 概述

已实现用户账户系统，包括：
- ✅ 用户注册/登录
- ✅ 数据云端同步
- ✅ 多设备访问（含多设备实时同步）

本项目在 Supabase 中命名为 **readtrip**。若你已在 Dashboard 的 SQL Editor 中成功执行迁移脚本并看到 “Success. No rows returned”，则表与 RLS 已就绪。

## 数据库设置步骤

### 1. 在 Supabase Dashboard 中执行 SQL 脚本

1. 登录 [Supabase Dashboard](https://app.supabase.com)
2. 选择项目 **readtrip**
3. 进入 **SQL Editor**
4. 打开 `supabase/migrations/001_create_reading_records.sql` 文件
5. 复制文件内容并粘贴到 SQL Editor
6. 点击 **Run** 执行脚本

### 2. 验证表创建成功

执行以下查询验证表是否创建成功：

```sql
SELECT * FROM reading_records LIMIT 1;
```

如果查询成功，说明表已创建。

### 3. 验证 RLS 策略

确保行级安全策略已启用：

```sql
SELECT * FROM pg_policies WHERE tablename = 'reading_records';
```

应该看到4条策略（SELECT, INSERT, UPDATE, DELETE）。

### 4. 启用多设备实时同步（可选）

若需在多个设备/标签页之间实时看到数据变化：

1. 在 Supabase Dashboard 进入 **Database** → **Replication**
2. 找到表 `reading_records`，开启 **Realtime** 开关

未开启时，多设备仍可访问同一份云端数据，但需刷新页面才能看到其他设备的修改。

## 功能说明

### 用户注册/登录

- 点击右上角的"登录"按钮
- 在弹窗中可以切换"登录"和"注册"标签页
- 注册时需要邮箱和密码（至少6位）
- 登录后，邮箱会显示在右上角

### 数据云端同步

- **登录前**：数据存储在浏览器本地（localStorage）
- **登录后**：
  - 自动从云端加载数据
  - 首次登录时，会将本地数据自动同步到云端
  - 之后的所有操作（添加、删除、更新）都会自动同步到云端
  - 同时也会保存到本地作为备份

### 多设备访问

- 登录后，在任何设备上使用相同账号登录，都可以访问你的阅读记录
- 开启 Realtime 后，在一台设备上的增删改会实时推送到其他已打开的页面/设备
- 未开启 Realtime 时，刷新页面即可看到最新数据

## 注意事项

1. **首次同步**：首次登录时，如果本地有数据，会自动上传到云端。如果云端已有数据，则不会覆盖云端数据。

2. **离线支持**：即使未登录，应用仍然可以正常使用，数据保存在本地。登录后会自动同步。

3. **数据安全**：使用 Supabase 的行级安全策略（RLS），确保用户只能访问自己的数据。

4. **环境变量**：确保 `.env` 文件中配置了正确的 Supabase 凭证：
   ```
   VITE_SUPABASE_URL=your_supabase_url
   VITE_SUPABASE_PUBLISHABLE_KEY=your_supabase_key
   ```

5. **注册后跳回当前界面（重要）**：  
   在 Supabase 项目 **readtrip** 中打开 **Authentication** → **URL Configuration**：
   - **Redirect URLs** 里添加你实际会用的地址，例如：
     - 本地开发：`http://localhost:8080`
     - 线上环境：`https://你的域名.com`（如已部署）
   - 这样用户在你当前打开的地址（如 localhost:8080）注册后，邮件里的验证链接会跳回**同一地址**，不会跳到别的旧版本。  
   其他用户访问并注册你的**线上最新部署**时，验证链接也会跳回该线上地址，看到的是最新界面。

## 故障排除

### 问题：登录后看不到数据

**解决方案**：
1. 检查浏览器控制台是否有错误
2. 确认数据库表已创建
3. 确认 RLS 策略已正确设置
4. 检查 Supabase 项目设置中的 API URL 和密钥是否正确

### 问题：同步失败

**解决方案**：
1. 检查网络连接
2. 查看浏览器控制台的错误信息
3. 确认 Supabase 项目状态正常
4. 尝试刷新页面重新登录

### 问题：无法注册账号

**解决方案**：
1. 检查邮箱格式是否正确
2. 确认密码长度至少6位
3. 查看 Supabase Dashboard 中的认证设置
4. 检查邮箱验证设置（某些 Supabase 配置可能需要邮箱验证）
