# 用户账户系统设置说明

## 概述

已实现用户账户系统，包括：
- ✅ 用户注册/登录
- ✅ 数据云端同步
- ✅ 多设备访问（含多设备实时同步）

本项目在 Supabase 中命名为 **readtrip**。若你已在 Dashboard 的 SQL Editor 中成功执行迁移脚本并看到 “Success. No rows returned”，则表与 RLS 已就绪。

## 数据库设置步骤

### 1. 在 Supabase Dashboard 中执行 SQL 脚本

1. 登录 [Supabase Dashboard](https://app.supabase.com)
2. 选择项目 **readtrip**
3. 进入 **SQL Editor**
4. 打开 `supabase/migrations/001_create_reading_records.sql` 文件
5. 复制文件内容并粘贴到 SQL Editor
6. 点击 **Run** 执行脚本

### 2. 验证表创建成功

执行以下查询验证表是否创建成功：

```sql
SELECT * FROM reading_records LIMIT 1;
```

如果查询成功，说明表已创建。

### 3. 验证 RLS 策略

确保行级安全策略已启用：

```sql
SELECT * FROM pg_policies WHERE tablename = 'reading_records';
```

应该看到4条策略（SELECT, INSERT, UPDATE, DELETE）。

### 4. 启用多设备实时同步（可选）

若需在多个设备/标签页之间实时看到数据变化：

1. 在 Supabase Dashboard 进入 **Database** → **Replication**
2. 找到表 `reading_records`，开启 **Realtime** 开关

未开启时，多设备仍可访问同一份云端数据，但需刷新页面才能看到其他设备的修改。

## 功能说明

### 用户注册/登录

- 点击右上角的"登录"按钮
- 在弹窗中可以切换"登录"和"注册"标签页
- 注册时需要邮箱和密码（至少6位）
- 登录后，邮箱会显示在右上角

### 数据云端同步

- **登录前**：数据存储在浏览器本地（localStorage）
- **登录后**：
  - 自动从云端加载数据
  - 首次登录时，会将本地数据自动同步到云端
  - 之后的所有操作（添加、删除、更新）都会自动同步到云端
  - 同时也会保存到本地作为备份

### 多设备访问

- 登录后，在任何设备上使用相同账号登录，都可以访问你的阅读记录
- 开启 Realtime 后，在一台设备上的增删改会实时推送到其他已打开的页面/设备
- 未开启 Realtime 时，刷新页面即可看到最新数据

## 注意事项

1. **首次同步**：首次登录时，如果本地有数据，会自动上传到云端。如果云端已有数据，则不会覆盖云端数据。

2. **离线支持**：即使未登录，应用仍然可以正常使用，数据保存在本地。登录后会自动同步。

3. **数据安全**：使用 Supabase 的行级安全策略（RLS），确保用户只能访问自己的数据。

4. **环境变量**：确保 `.env` 文件中配置了正确的 Supabase 凭证：
   ```
   VITE_SUPABASE_URL=your_supabase_url
   VITE_SUPABASE_PUBLISHABLE_KEY=your_supabase_key
   ```

5. **注册后跳回当前界面（重要）**：  
   在 Supabase 项目 **readtrip** 中打开 **Authentication** → **URL Configuration**：
   - **Redirect URLs** 里添加你实际会用的地址，例如：
     - 本地开发：`http://localhost:8080`
     - 线上环境：`https://www.readtrip.club` 和 `https://www.readtrip.club/`（必须都加）
   - 这样用户在你当前打开的地址注册后，邮件里的验证链接会跳回**同一地址**。  
   - **若用户点击邮件里的确认链接显示错误**：在 **Site URL** 填 `https://www.readtrip.club`，在 **Redirect URLs** 中确保有 `https://www.readtrip.club` 和 `https://www.readtrip.club/`（两条都保留），保存后让用户重新点邮件链接或重新注册一次。

6. **AI 匹配书籍 / 批量导入（线上可用）**：  
   “AI 匹配”和“批量导入”依赖 Supabase 的 **Edge Function** `match-book`，需要单独部署并配置密钥后线上才能用：
   - 在 Supabase 项目 **readtrip** 中进入 **Edge Functions**，若没有 `match-book`，需用 Supabase CLI 部署（见下方「部署 match-book 函数」）。
   - 在 **Edge Functions** → **match-book** → **Settings**（或 **Secrets**）中设置环境变量 **LOVABLE_API_KEY**（值为 Lovable 提供的 AI 网关密钥）。若你没有该密钥，AI 匹配会报错，可改为在应用内手动填写书名、作者、国家等信息。
   - 部署方式（在项目根目录执行）：
     ```bash
     npx supabase login
     npx supabase link --project-ref 你的项目ID   # 项目 ID 在 Supabase Dashboard 的 Project Settings → General 里
     npx supabase functions deploy match-book
     npx supabase secrets set LOVABLE_API_KEY=你的Lovable密钥
     ```
   - 若暂时不部署：用户仍可正常使用「手动填写」添加书籍；批量导入时 Excel 中**每行需包含完整信息**（书名、作者、国家或国家代码），否则缺少信息的行会依赖 AI 匹配而失败。

## 故障排除

### 问题：登录后看不到数据

**解决方案**：
1. 检查浏览器控制台是否有错误
2. 确认数据库表已创建
3. 确认 RLS 策略已正确设置
4. 检查 Supabase 项目设置中的 API URL 和密钥是否正确

### 问题：同步失败

**解决方案**：
1. 检查网络连接
2. 查看浏览器控制台的错误信息
3. 确认 Supabase 项目状态正常
4. 尝试刷新页面重新登录

### 问题：无法注册账号

**解决方案**：
1. 检查邮箱格式是否正确
2. 确认密码长度至少6位
3. 查看 Supabase Dashboard 中的认证设置
4. 检查邮箱验证设置（某些 Supabase 配置可能需要邮箱验证）

### 问题：点击邮件里的确认链接显示错误

**解决方案**：
1. 在 Supabase **Authentication** → **URL Configuration** 中，**Site URL** 设为 `https://www.readtrip.club`
2. 在 **Redirect URLs** 中新增并保存：`https://www.readtrip.club` 和 `https://www.readtrip.club/`（两条都要有）
3. 保存后让用户再次点击邮件中的确认链接；若仍失败，可尝试重新注册一次

### 问题：AI 匹配书籍 / 批量导入无法使用

**解决方案**：
1. 确认已在 Supabase 部署 **Edge Function** `match-book` 并设置 **LOVABLE_API_KEY**（见上方「AI 匹配书籍 / 批量导入」）
2. 若无法配置 AI：可改为在记录足迹时**手动填写**书名、作者、国家；批量导入时保证 Excel 每行都有「书名、作者、国家或国家代码」，即可不依赖 AI 正常导入
